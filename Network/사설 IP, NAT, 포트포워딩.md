전 세계적으로 인터넷 사용자 수가 급증하면서 IPv4 주소가 고갈될 위기에 처해있다. 따라서 새로운 주소체계인 IPv6가 나왔지만, 기존의 주소 체계를 변경하는데 천문학적인 비용이 들어서 아직까지도 IPv4를 사용하고 있는 실정이다. 기존의 주소 체계에서 일종의 수학적인 트릭을 고안해서 사용하고 있는데, 그 트릭 중 하나가 바로 사설 IP 개념이다. 

<br>

### 고정 IP, 유동 IP, 공인 IP, 사설 IP

사설 IP를 알기 전에, 아이피는 4가지로 나뉘어 쓰이는데 이 부분부터 알고 가자.

#### 고정 IP

말 그대로 변하지 않고 컴퓨터에 고정적으로 부여된 IP

한 번 부여되면 IP 반납 전까지는 다른 장비에 부여할 수 없는 고유의 IP로 보안성이 우수하기 때문에 보안이 필요한 업체나 기관에서 사용한다. 

#### 유동 IP

역시 말 그대로 변하는 IP

인터넷 사용자 모두에게 고정 IP를 부여해주기는 힘들기 때문에, 일정한 주기 또는 사용자들이 인터넷을 접속하는 매 순간마다 사용하고 있지 않은 IP주소를 임시로 발급해주는 IP이다. 대부분의 사용자는 유동 IP를 사용한다. 

#### 공인 IP

IP 주소는 임의로 우리가 부여하는 것이 아니라 전 세계적으로 ICANN이라는 기관이 국가별로 사용할 IP 대역을 관리하고, 우리나라는 한국인터넷진흥원(KISA)에서 국내 IP 주소들을 관리하고 있다. 이것을 ISP가 부여받고, 우리는 위 회사에 가입을 통해 IP를 제공받아 인터넷을 사용하게 되는 것이다. 이렇게 발급받은 IP를 공인 IP라고 한다. 
- ISP는 Internet Service Provider의 약자로, KT, SKT, LG와 같이 인터넷을 제공하는 통신업체

#### 사설 IP

공유기를 사용한 인터넷 접속 환경일 경우 **공유기까지는 공인 IP 할당을 하지만, 공유기에 연결되어 있는 가정이나 회사의 각 네트워크 기기에는 사설 IP를 할당**한다. 

즉, 사설 IP는 **어떤 네트워크 안에서만 내부적으로 사용되는** 고유한 주소이다. 사설 IP는 보통 내 컴퓨터에서 사용하는 로컬 IP라고도 불리운다. 

- 따라서 같은 아이피 번호를 중복해서 마구 사용할 수 있고, 이는 곧 IP의 절약과 연관된다. 

공인 IP는 전 세계에서 유일하지만, 사설 IP는 하나의 네트워크 안에서 유일하다. 공인 IP는 외부, 내부 상관없이 해당 IP에 접속할 수 있으나, 사설 IP는 내부에서만 접근이 가능하다. 

<br>

### NAT

IP를 절약하는 트릭에 대해서는 이제 이해가 됐다. 그렇다면 사설망 안에 있는 컴퓨터는 어떻게 외부와 통신할까? 여기서 바로 NAT(Network Adress Translation)이란 개념이 등장한다. 

NAT은 **패킷의 IP header에 있는 주소를 수정하여** 기존 IP 주소에서 다른 IP 주소로 매핑하는 기법의 총칭이다. NAT는 NAT Table이라는 테이블로 변환해야 할 주소들을 관리하고 있다. 

- 기본 게이트웨이(공유기 등)에서는 외부로 나가는 패킷을 인식하게 되면, **출발지의 IP 주소를** 게이트웨이 자신의 **공인 IP 주소로 변경**한다. 이때, 별도의 NAT 테이블을 보관한다.
- 호스트의 기본 게이트웨이에서 웹 서버가 보낸 패킷을 받으면, 기록해두었던 NAT 테이블을 참조하여 **최종 목적지인 호스트의 사설 IP 주소로 변경**하여 해당 호스트로 패킷을 전달한다. 

NAT는 공인 IP 주소를 절약할 수 있고, 내부 사설망을 보호할 수 있다. 경우에 따라서는 호스트의 부하를 분산시킬 수 있는 로드 밸런싱이 가능하다. 하지만, 패킷을 변환시키고 그 과정에서 체크섬도 다시 계산하기 때문에 복잡성을 증가시켜서 네트워크 성능에 영향을 줄 수 있다. 또한, FTP, SIP 등의 프로토콜에서는 사용할 수 없다. 

<br>

> #### Static NAT (1:1)
> 공인 IP 주소와 사설 IP 주소가 1:1로 매핑되는 방식이다. 구성 특성상 공인 IP 주소의 절약 효과는 없다. 

> #### Dynamic NAT (N:M)
> 사설 IP 그룹과 공인 IP 그룹을 매핑한다. 공인 IP 주소의 개수가 사설 IP 주소의 개수보다 적을 때 사용하며, 1:1 방식이 아니기 때문에 일반적으로 주소 매핑이 고정적이지 않다. 따라서 내부에서 외부로의 통신만 가능하다. 


### NAT의 문제

**두 호스트가 동시에 같은** 외부 네트워크 목적지와 통신하는 경우, 기존의 NAT만으로는 라우터가 어느 호스트에 보내줘야 할지 알 수 없다. 따라서, 라우터가 어느 호스트가 받아야 하는지 알 수 있도록 정보(포트)를 추가해야 한다. 

> #### NAPT (1:N) = PAT
> NAT에 포트 정보를 추가한 개념으로, 각각의 내부 호스트에 포트 번호를 부여하여 **하나의 외부 IP 주소로 전송해도 포트 번호로 호스트를 구별**할 수 있게 도와준다. Dynamic NAT과 동일하게, 호스트들이 고정 포트로 구분된 상태가 아니므로 **외부에서 내부로의 통신은 불가하다.**

- 위 개념에서 **포트를 고정하여 외부에서 내부로 접속이 가능하게끔** 도와주는 개념이 <ins>**포트포워딩**</ins>이다.

<br>

### 참고

https://inpa.tistory.com/entry/WEB-%F0%9F%8C%90-IP-%EA%B8%B0%EC%B4%88-%EC%82%AC%EC%84%A4IP-%EA%B3%B5%EC%9D%B8IP-NAT-%EA%B0%9C%EB%85%90-%EC%A0%95%EB%A7%90-%EC%89%BD%EA%B2%8C-%EC%A0%95%EB%A6%AC#%EA%B3%B5%EC%9D%B8_ip_/_%EC%82%AC%EC%84%A4_ip_/_%EA%B3%A0%EC%A0%95_ip_/_%EC%9C%A0%EB%8F%99_ip

https://www.stevenjlee.net/2020/07/11/%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-nat-network-address-translation-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%A3%BC%EC%86%8C-%EB%B3%80%ED%99%98/

https://80000coding.oopy.io/2679bd9e-1678-47c8-b969-a8647bcfc9bb

https://8iggy.tistory.com/249
